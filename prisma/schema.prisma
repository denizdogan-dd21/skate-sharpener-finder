// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserType {
  CUSTOMER
  SHARPENER
  ADMIN
}

model User {
  userId           Int                    @id @default(autoincrement())
  email            String
  password         String
  userType         UserType
  firstName        String
  lastName         String
  phone            String
  bio              String?
  isEmailVerified  Boolean                @default(false)
  averageRating    Float?
  totalRatings     Int                    @default(0)
  
  // Account status fields
  active           Boolean                @default(true)
  suspended        Boolean                @default(false)
  suspensionReason String?
  suspensionEndDate DateTime?
  
  // Two-factor authentication fields
  twoFactorEnabled Boolean                @default(true)
  twoFactorSecret  String?
  
  createdAt        DateTime               @default(now())
  
  // Relations
  locations        SharpenerLocation[]
  customerAppointments Appointment[]      @relation("CustomerAppointments")
  sharpenerAppointments Appointment[]     @relation("SharpenerAppointments")
  customerRatings  Rating[]               @relation("CustomerRatings")
  sharpenerRatings Rating[]               @relation("SharpenerRatings")
  adminActions     AdminAction[]

  @@unique([email, userType])
  @@map("tblUsers")
}

model SharpenerLocation {
  locationId       Int                    @id @default(autoincrement())
  sharpenerId      Int
  locationName     String
  streetAddress    String
  city             String
  state            String
  zipCode          String
  latitude         Float?
  longitude        Float?
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  
  sharpener        User                   @relation(fields: [sharpenerId], references: [userId], onDelete: Cascade)
  machines         SharpeningMachine[]
  availabilities   Availability[]
  appointments     Appointment[]

  @@map("tblSharpenerLocations")
}

model SharpeningMachine {
  machineId        Int                    @id @default(autoincrement())
  locationId       Int
  machineType      String
  radiusOptions    String                 // Comma-separated values like "1/2, 5/8, 3/4"
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  
  location         SharpenerLocation      @relation(fields: [locationId], references: [locationId], onDelete: Cascade)
  availabilities   Availability[]
  appointments     Appointment[]

  @@map("tblSharpeningMachines")
}

model Availability {
  availabilityId   Int                    @id @default(autoincrement())
  locationId       Int
  machineId        Int
  availableDate    DateTime
  startTime        String                 // Format: "HH:MM"
  endTime          String                 // Format: "HH:MM"
  price            Float
  createdAt        DateTime               @default(now())
  
  location         SharpenerLocation      @relation(fields: [locationId], references: [locationId], onDelete: Cascade)
  machine          SharpeningMachine      @relation(fields: [machineId], references: [machineId], onDelete: Cascade)
  appointments     Appointment[]

  @@map("tblAvailability")
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  DENIED
  CANCELLED
  COMPLETED
  RATED
  EXPIRED
  NO_SHOW
}

model Appointment {
  appointmentId    Int                    @id @default(autoincrement())
  userId           Int
  sharpenerId      Int
  locationId       Int
  machineId        Int
  availabilityId   Int
  requestedDate    DateTime
  startTime        String
  endTime          String
  status           AppointmentStatus      @default(PENDING)
  notes            String?
  canceledBy       String?                // 'customer', 'sharpener', or null
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  
  user             User                   @relation("CustomerAppointments", fields: [userId], references: [userId], onDelete: Cascade)
  sharpener        User                   @relation("SharpenerAppointments", fields: [sharpenerId], references: [userId], onDelete: Cascade)
  location         SharpenerLocation      @relation(fields: [locationId], references: [locationId], onDelete: Cascade)
  machine          SharpeningMachine      @relation(fields: [machineId], references: [machineId], onDelete: Cascade)
  availability     Availability           @relation(fields: [availabilityId], references: [availabilityId], onDelete: Cascade)
  rating           Rating?

  @@map("tblAppointments")
}

model Rating {
  ratingId         Int                    @id @default(autoincrement())
  appointmentId    Int                    @unique
  userId           Int
  sharpenerId      Int
  rating           Int                    // 1-5
  comment          String?
  createdAt        DateTime               @default(now())
  
  appointment      Appointment            @relation(fields: [appointmentId], references: [appointmentId], onDelete: Cascade)
  user             User                   @relation("CustomerRatings", fields: [userId], references: [userId], onDelete: Cascade)
  sharpener        User                   @relation("SharpenerRatings", fields: [sharpenerId], references: [userId], onDelete: Cascade)

  @@map("tblRatings")
}

model EmailVerificationToken {
  tokenId          Int                    @id @default(autoincrement())
  email            String
  token            String                 @unique
  userType         UserType               // CUSTOMER, SHARPENER, or ADMIN
  expiresAt        DateTime
  createdAt        DateTime               @default(now())

  @@unique([email, userType])
  @@map("tblEmailVerificationTokens")
}

model TwoFactorToken {
  tokenId          String                 @id @default(uuid())
  email            String
  userType         UserType
  token            String                 // 6-digit OTP code
  expiresAt        DateTime               // Valid for 10 minutes
  used             Boolean                @default(false)
  createdAt        DateTime               @default(now())

  @@unique([email, userType, token])
  @@map("tblTwoFactorTokens")
}

enum AdminActionType {
  SUSPEND
  UNSUSPEND
  DEACTIVATE
  ACTIVATE
}

model AdminAction {
  actionId         String                 @id @default(uuid())
  adminId          Int
  actionType       AdminActionType
  targetUserId     Int
  targetUserEmail  String
  reason           String?
  createdAt        DateTime               @default(now())
  
  admin            User                   @relation(fields: [adminId], references: [userId], onDelete: Cascade)

  @@map("tblAdminActions")
}
